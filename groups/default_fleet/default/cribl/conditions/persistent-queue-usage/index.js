exports.name="Persistent Queue Usage";exports.type="metric";exports.category="destinations";let id;let name;let __workerGroup;let timeWindow;let usageThreshold;let usageThresholdDecimal;let notifyOnResolution;exports.init=e=>{id=e.pid;const t=e.conf||{};({name,__workerGroup,timeWindow,usageThreshold,notifyOnResolution}=t);timeWindow=timeWindow||"60s";usageThreshold=usageThreshold!=null?usageThreshold:90;usageThresholdDecimal=usageThreshold/100;notifyOnResolution=notifyOnResolution||false};exports.build=()=>{let e="";let t=`_metric === 'system.pq_used' && output === '${name}'`;let i=`'Destination ${name} persistent queue usage greater than ${usageThreshold}% threshold in ${timeWindow}'`;let s=`'Destination ${name} persistent queue usage is within ${usageThreshold}% threshold in ${timeWindow}'`;if(__workerGroup){t=`${t} && __worker_group === '${__workerGroup}'`;e=` in group ${__workerGroup}`;i=`'Destination ${name}${e} persistent queue usage greater than ${usageThreshold}% threshold in ${timeWindow}'`;s=`'Destination ${name}${e} persistent queue usage is within ${usageThreshold}% threshold in ${timeWindow}'`}return{filter:t,pipeline:{conf:{functions:[{id:"aggregation",conf:{timeWindow,aggregations:["last(_value).as(queue_usage)"],lagTolerance:"20s",idleTimeLimit:"20s"}},{id:"eval",conf:{add:[{name:"output",value:`'${name}'`},{name:"timewindow",value:`'${timeWindow}'`},{name:"usageThreshold",value:`'${usageThreshold}'`},{name:"_metric",value:"'system.pq_used'"},{name:"usage",value:"`${queue_usage * 100}`"}]}},{id:"eval",filter:`queue_usage > ${usageThresholdDecimal}`,conf:{add:[{name:"_raw",value:`${i}`},{name:"status",value:`'ALARM'`}]}},{id:"eval",filter:`typeof queue_usage === 'undefined' || queue_usage <= ${usageThresholdDecimal}`,conf:{add:[{name:"_raw",value:`${s}`},{name:"status",value:`'OK'`}]}},{id:"notifications",conf:{id,field:"status",deduplicate:notifyOnResolution}},{id:"drop",filter:`!(${notifyOnResolution}) && status === 'OK'`}]}}}};