const{Expression}=C.expr;exports.name="CEF Serializer";exports.version="0.2";exports.disabled=false;exports.group="Formatters";exports.sync=true;const{NestedPropertyAccessor}=C.expr;const DEFAULT_OUT_FIELD="_raw";const headerSet=new Set(["cef_version","device_vendor","device_product","device_version","device_event_class_id","name","severity"]);let headerKeys=[];let headerExpr=[];let extKeys=[];let extExpr=[];let outputField;function difference(e,r){return new Set([...e].filter((e=>!r.has(e))))}function validateHeaders(e){if(e.length!==[...headerSet].length){const r=new Set(e);const s=difference(headerSet,r);throw new Error(`Missing headers=${JSON.stringify([...s])}`)}const r=new Set(e);const s=difference(r,headerSet);if([...s].length>0){throw new Error(`Invalid headers=${[...s]}`)}}exports.init=e=>{const r=e.conf||{};headerKeys=[];headerExpr=[];extKeys=[];extExpr=[];outputField=new NestedPropertyAccessor(r.outputField||DEFAULT_OUT_FIELD);(r.header||[]).forEach((e=>{headerKeys.push(e.name);headerExpr.push(new Expression(`${e.value}`,{disallowAssign:true}))}));validateHeaders(headerKeys);(r.extension||[]).forEach((e=>{if(e.name.includes("\n"))throw new Error("Extension field names cannot contain new lines");extKeys.push(e.name);extExpr.push(new Expression(`${e.value}`,{disallowAssign:true}))}))};function stringify(e){if(e===undefined)return"";if(typeof e==="string")return e;try{return JSON.stringify(e)}catch(r){return`${e}`}}const headerEscapeChars=/([\\|])/g;const extensionEscapeChars=/([\\=])/g;exports.process=e=>{const r={};for(let s=0;s<headerKeys.length;s++){r[headerKeys[s]]=stringify(headerExpr[s].evalOn(e)).replace(headerEscapeChars,"\\$1")}const s=`${r.cef_version||"CEF:0"}|${r.device_vendor}|${r.device_product}|${r.device_version}|${r.device_event_class_id}|${r.name}|${r.severity}|`;const t=[];for(let r=0;r<extKeys.length;r++){const s=stringify(extExpr[r].evalOn(e)).replace(extensionEscapeChars,"\\$1");const n=extKeys[r].replace(extensionEscapeChars,"\\$1");t.push(`${n}=${s}`)}outputField.set(e,s+t.join(" "));return e};