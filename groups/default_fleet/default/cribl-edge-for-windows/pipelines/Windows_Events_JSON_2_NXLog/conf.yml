output: default
streamtags: []
groups:
  VrDhhP:
    name: Optional Event Optimization
    description: oggle this group on in order to drop, sample, or suppress low value
      events by event ID
    disabled: true
    index: 3
  NOdPOX:
    name: For sending to Devo syslog - disable for other destinations
    disabled: true
    index: 14
asyncFuncTimeout: 1000
functions:
  - id: comment
    filter: "true"
    disabled: null
    conf:
      comment: >+
        This pipeline transforms Edge Windows Events from JSON to NXLog format,
        and can be used to integrate Cribl Edge with destinations where NXLog
        format is required.  Light testing has been performed with Devo with
        success, however further testing is recommended for your environment/use
        case.


        When sending to Devo, we recommend using syslog and enabling the optional Devo function group below.


        Another optional function group can be enabled below where event level optimization is required.  You will need to modify the knowledge object WEL_EventIDs_2_Optimize.csv, ensuring the event IDs along with how you'd like them handled (this supports drop, sample, or suppress OOTB).


        Use the corresponding JSON labeled sample files included in this pack for testing this pipeline.

  - id: eval
    filter: "true"
    disabled: false
    conf:
      add:
        - disabled: false
          name: _raw
          value: JSON.parse(_raw)
      remove:
        - _raw.Qualifiers
        - _raw.RelatedActivityId
        - _raw.Bookmark
        - _raw.LogName
        - _raw.host
        - _raw.UserId
        - _raw.MatchedQueryIds
  - id: comment
    filter: "true"
    disabled: null
    conf:
      comment: Toggle the below function group to optimize windows events by ID
  - id: lookup
    filter: "true"
    disabled: true
    conf:
      matchMode: exact
      reloadPeriodSec: -1
      addToEvent: false
      inFields:
        - eventField: _raw.Id
          lookupField: EventID
      ignoreCase: false
      file: WEL_EventIDs_2_Optimize.csv
      outFields:
        - lookupField: Action
          eventField: __optimize_action
    groupId: VrDhhP
    description: Update the below lookup to manage which events to drop, sample, or suppress
  - id: drop
    filter: __optimize_action=='drop'
    disabled: true
    conf: {}
    groupId: VrDhhP
  - id: sampling
    filter: __optimize_action=='sample'
    disabled: true
    conf:
      rules:
        - filter: "true"
          rate: 5
    groupId: VrDhhP
  - id: suppress
    filter: __optimize_action=='suppress'
    disabled: true
    conf:
      allow: 1
      suppressPeriodSec: 30
      dropEventsMode: true
      maxCacheSize: 50000
      cacheIdleTimeoutPeriods: 2
      numEventsIdleTimeoutTrigger: 10000
      keyExpr: _raw.Id
    groupId: VrDhhP
  - id: auto_timestamp
    filter: "true"
    disabled: false
    conf:
      srcField: _time
      dstField: _raw.EventReceivedTime
      defaultTimezone: UTC
      timeExpression: C.Time.strftime(_time, "%Y-%m-%d %H:%M:%S")
      offset: 0
      maxLen: 150
      defaultTime: now
      latestDateAllowed: +1week
      earliestDateAllowed: -420weeks
      timestamps: []
    description: "format EventReceivedTime like this: 2023-09-14 16:15:29"
  - id: rename
    filter: "true"
    disabled: false
    conf:
      wildcardDepth: 5
      rename:
        - currentName: ActivityId
          newName: ActivityID
        - currentName: TaskDisplayName
          newName: Category
        - currentName: ContainerLog
          newName: Channel
        - currentName: MachineName
          newName: Hostname
        - currentName: Id
          newName: EventID
        - currentName: Level
          newName: SeverityValue
        - currentName: LevelDisplayName
          newName: Severity
        - currentName: Opcode
          newName: OpcodeValue
        - currentName: OpcodeDisplayName
          newName: Opcode
        - currentName: ProcessId
          newName: ProcessID
        - currentName: ProviderName
          newName: SourceName
        - currentName: RecordId
          newName: RecordNumber
        - currentName: TimeCreated
          newName: EventTime
        - currentName: KeywordsDisplayNames
          newName: EventType
        - currentName: ProviderId
          newName: ProviderGuid
        - currentName: ThreadId
          newName: ThreadID
      baseFields:
        - _raw
  - id: eval
    filter: "true"
    disabled: false
    conf:
      add:
        - name: Version
          value: "`${_raw.Version}`"
        - name: EventID
          value: "`${_raw.EventID}`"
        - disabled: false
          name: Properties
          value: _raw.Properties
        - disabled: false
          name: SourceName
          value: _raw.SourceName
    description: "Move fields needed for lookup "
  - id: lookup
    filter: "true"
    disabled: false
    conf:
      matchMode: exact
      reloadPeriodSec: -1
      addToEvent: false
      inFields:
        - eventField: SourceName
          lookupField: provider
        - eventField: EventID
          lookupField: event_code
        - eventField: Version
          lookupField: version
      ignoreCase: false
      outFields:
        - lookupField: fields
          eventField: __fields
      file: win_template.csv
  - id: code
    filter: "true"
    disabled: false
    conf:
      maxNumOfIterations: 5000
      activeLogSampleRate: 1
      useUniqueLogChannel: false
      code: |-
        const keys = __e['__fields']
        const k = keys.split(',')
        const vals = __e['Properties']
        const v = vals.map(entry => entry.Value)

        var raw = __e['_raw']
        k.forEach((key, index) => {
            raw[key] = v[index];
        });
        __e['_raw'] = raw
    description: creates kv fields based on message
    final: false
  - id: eval
    filter: "true"
    disabled: false
    conf:
      remove:
        - _raw.Properties
        - _raw.ProcessId
      add:
        - name: _raw.EventTime
          value: _raw.EventTime.substr(6, 13)
          disabled: false
        - name: _raw.EventType
          value: _raw.EventType[0].toUpperCase().replace(/ /g, '_')
          disabled: false
        - disabled: false
          name: _raw.LogonType
          value: _raw.LogonType.toString()
        - disabled: false
          name: _raw.TargetLogonId
          value: _raw.TargetLogonId.toString()
        - disabled: false
          name: _raw.SubjectLogonId
          value: _raw.SubjectLogonId.toString()
        - disabled: false
          name: _raw.Status
          value: _raw.Status.toString()
        - disabled: false
          name: _raw.Severity
          value: _raw.Severity=='Critical' && 'CRIT' || _raw.Severity=='Error' && 'ERR' ||
            _raw.Severity=='Warning' && 'WARN' || _raw.Severity=='Information'
            && 'INFO' || _raw.Severity=='Verbose' && 'VERBOSE' ||
            _raw.Severity=='Audit Success' && 'AUDIT_SUCCESS' ||
            _raw.Severity=='Audit Failure' && 'AUDIT_FAILURE' || 'INFO'
        - disabled: false
          name: _raw.SourceModuleName
          value: "'eventlog'"
        - disabled: false
          name: _raw.SourceModuleType
          value: "'im_msvistalog'"
        - disabled: false
          value: "_raw.ActivityID==null ? undefined : _raw.ActivityID"
          name: _raw.ActivityID
    description: Final cleanup and tweaks
  - id: mask
    filter: "true"
    disabled: false
    conf:
      rules:
        - disabled: false
          matchRegex: /([0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})/gmi
          replaceExpr: |
            `{${g1}}`.toUpperCase()
      fields:
        - _raw*
      depth: 5
    description: fix GUID formatting
  - id: numerify
    filter: "true"
    disabled: false
    conf:
      format: none
      ignoreFields:
        - "!_raw.EventID"
        - "!_raw.Keywords"
        - "!_raw.OpcodeValue"
        - "!_raw.ProcessID"
        - "!_raw.RecordNumber"
        - "!_raw.SeverityValue"
        - "!_raw.Task"
        - "!_raw.ThreadID"
        - "!_raw.Version"
        - "*"
      filterExpr: ""
      digits: 0
    description: match number types to nxlog
  - id: auto_timestamp
    filter: "true"
    disabled: false
    conf:
      srcField: _raw.EventTime
      dstField: _raw.EventTime
      defaultTimezone: UTC
      timeExpression: C.Time.strftime((_raw.EventTime/1000), "%Y-%m-%d %H:%M:%S")
      offset: 0
      maxLen: 150
      defaultTime: now
      latestDateAllowed: +1week
      earliestDateAllowed: -420weeks
      timestamps: []
    description: "Fix EventTime format "
  - id: comment
    filter: "true"
    disabled: null
    conf:
      comment: Following optional group for sending to Devo syslog
  - id: eval
    filter: "true"
    disabled: true
    conf:
      add:
        - disabled: false
          name: appname
          value: "`box.win_nxlog.${_raw.Channel}`.toLowerCase()"
        - disabled: false
          name: severity
          value: "1"
        - disabled: false
          name: facility
          value: "3"
        - disabled: false
          name: priority
          value: "14"
        - disabled: false
          name: __syslogout
          value: '`<${priority}>${C.Time.strftime(_time,"%b %d %H:%M:%S")}
            ${_raw.Hostname} ${appname}[${_raw.ProcessID}]:
            ${JSON.stringify(_raw)}`'
        - disabled: true
          name: viewSyslogOut
          value: __syslogout
    description: build syslog payload (__syslogOut), toggle viewSyslog if you don't
      want to have to view hidden fields
    groupId: NOdPOX
  - id: eval
    filter: "true"
    disabled: null
    conf:
      remove:
        - EventID
        - Properties
        - SourceName
        - Version
        - source
        - host
    description: Final clean up
  - id: eval
    filter: "true"
    disabled: true
    conf: {}
    description: Debugger - move this up to set breakpoint
    final: true
