const{Expression}=C.expr;const cLogger=C.util.getLogger("func:suppress");exports.name="Suppress";exports.version="0.1";exports.disabled=false;exports.group="Standard";exports.sync=true;let _primaryCache=new Map;let _secondaryCache=new Map;let _expression=null;let _numToAllow;let _suppressionMs;let _dropEvents=true;let _numEventsReceived=0;let _cacheExpirationMs;let _maxCacheSize;let _cacheCleanupNumEvents;function getCacheEntry(e,s){let n=_primaryCache.get(e);if(!n){n=_secondaryCache.get(e);if(n){_primaryCache.set(e,n)}else{const r=s+_suppressionMs;n={count:0,expirationTime:r};_primaryCache.set(e,n)}}return n}function cleanCache(){_secondaryCache=_primaryCache;_primaryCache=new Map}exports.init=e=>{const s=e.conf;const n=s.keyExpr||"";_numToAllow=s.allow||1;_suppressionMs=Number(s.suppressPeriodSec*1e3)||300*1e3;_maxCacheSize=s.maxCacheSize||5e4;_cacheCleanupNumEvents=s.numEventsIdleTimeoutTrigger||1e5;const r=s.cacheIdleTimeoutPeriods||2;_cacheExpirationMs=_suppressionMs*Number(r);_dropEvents=s.dropEventsMode===undefined||Boolean(s.dropEventsMode);if(n.length>0){_expression=new Expression(n,{disallowAssign:true})}_primaryCache=new Map;_secondaryCache=new Map;_numEventsReceived=0;cLogger.info("initialized suppress function",{keyExpr:n,numToAllow:_numToAllow,dropEventsMode:_dropEvents,supressionMs:_suppressionMs,cacheExpirationMs:_cacheExpirationMs,maxCacheSize:_maxCacheSize,cacheCleanupNumEvents:_cacheCleanupNumEvents})};exports.process=e=>{if(!_expression||!e){if(e){e.suppress=0}return e}const s=_expression.evalOn(e);if(s===undefined||s===null){e.suppress=0;return e}_numEventsReceived++;if(_numEventsReceived%_cacheCleanupNumEvents===0&&_primaryCache.size>=_maxCacheSize){cleanCache()}const n=C.util.getEventTimeInMs(e)||Date.now();const r=getCacheEntry(s,n);if(r.count===0){r.count=1;e.suppress=0;return e}let t=false;const o=r.count>_numToAllow?r.count-_numToAllow:0;if(n>r.expirationTime){r.expirationTime=n+_suppressionMs;r.count=0;t=true}if(r.count<_numToAllow){r.count++;e.suppress=0;if(t&&o>0){e.suppressCount=o}return e}r.count++;if(_dropEvents){return undefined}e.suppress=1;e.suppressCount=o+1;return e};exports.unload=()=>{_numEventsReceived=0;_primaryCache=new Map;_secondaryCache=new Map};exports.getCacheSize=()=>_primaryCache.size;